{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'static-resume/style.css' %}">
    <title>Document</title>
</head>
<body>
    <h1>Hello World</h1>
    
    <!-- <embed src="{{ MEDIA_URL }}media-resume/resume.pdf" type="application/pdf" width="100%" height="600px" title="PDF Document"></embed> -->

    <iframe id="pdfPreview" width="100%" height="600px" frameborder="0" title="PDF Document"></iframe>
    <!-- src="{{ MEDIA_URL }}media-resume/resume.pdf" -->

    <div class="main-container">
        <form id="add-experience-form" class="sub-container">
            {% csrf_token %}
        

            <div class="dropdown">
            <button id="dropdownBtn" class="dropdown-btn">Select a section ▼</button>
            <div id="dropdownContent" class="dropdown-content">
                <a href="#" data-value="Education ▼">Education</a>
                <a href="#" data-value="Technical Skills ▼">Technical Skills</a>
                <a href="#" data-value="Work Experiences ▼">Work Experiences</a>
                <a href="#" data-value="Personal Projects ▼">Personal Projects</a>
                <a href="#" data-value="Interpersonal Skills ▼">Interpersonal Skills</a>
            </div>
            </div>


            <label for="name">Experience Name:</label>
            <input type="text" id="name" name="name" maxlength="100" required><br><br>
            <label for="date">Date:</label>
            <input type="text" id="date" name="date" maxlength="100" required><br><br>
            <label for="location">Location:</label>
            <input type="text" id="location" name="location" maxlength="100" required><br><br>
            <label for="organisation">Organisation:</label>
            <input type="text" id="organisation" name="organisation" maxlength="100" required><br><br>
        
            <label for="description1">Description 1:</label>
            <textarea id="description1" name="descriptions[]" rows="3" cols="50"></textarea><br><br>
            <label for="description2">Description 2:</label>
            <textarea id="description2" name="descriptions[]" rows="3" cols="50"></textarea><br><br>
            <label for="description3">Description 3:</label>
            <textarea id="description3" name="descriptions[]" rows="3" cols="50"></textarea><br><br>
        
            <button type="submit">Submit Experience</button>
        </form>   

        <div class="sub-container">
            <h1 id="section">Experiences</h1>
            <div id="minor-experiences-container" class="content-container">
            </div>
        </div>
    </div>

    <form id="prepare-pdf-form">
        <button type="submit">Prepare pdf</button>
    </form>
    <form id="reset-panel-form">
        <button type="submit">Reset panel</button>
    </form>


</body>
<script>
    function chooseOption(option) {
        // Replace alert with your actual handling logic
    }
    const dropdownBtn = document.getElementById('dropdownBtn');
    const dropdown = document.querySelector('.dropdown');
    const dropdownContent = document.getElementById('dropdownContent');

    dropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // prevent window click from instantly closing it
        dropdown.classList.toggle('show');
    });

    // Update the button text when an option is clicked
    dropdownContent.querySelectorAll('a').forEach(option => {
        option.addEventListener('click', (e) => {
        e.preventDefault();
        dropdownBtn.textContent = option.dataset.value;
        dropdown.classList.remove('show'); // close menu after selection
        });
    });

    // Close dropdown if clicked outside
    window.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('show');
        }
    });



    const form = document.getElementById("add-experience-form");
    const PREPARE_PDF_URL = "{% url 'prepare_pdf' %}";
    const RESET_PANEL_URL = "{% url 'reset_panel' %}";
    const DELETE_URL = "{% url 'delete_experience' %}";
    const EDIT_URL = "{% url 'edit_experience' %}";
    const EDIT_PDF_URL = "{% url 'edit_pdf' %}";

    window.onload = () => {
        fetch(PREPARE_PDF_URL);    
        fetch(RESET_PANEL_URL);
    };

    form.addEventListener("submit", async function(event) {
        event.preventDefault(); // prevent page reload

        const formData = new FormData(form);
        const response = await fetch(`{% url 'add_experience' %}?type=minor-experience`, {
            method: "POST",
            headers: {
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            },
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            console.log("Experience added successfully:", data);
            form.reset();
            fetch(RESET_PANEL_URL);
        } else {
            console.error("Error adding experience");
        }
    });

    const form2 = document.getElementById("prepare-pdf-form");
    form2.addEventListener("submit", async function(event) {
        event.preventDefault(); // prevent page reload

        const formData2 = new FormData(form);

        // Fetch POST request to your Django view
        const response = await fetch(PREPARE_PDF_URL, {
            method: "POST",
            headers: {
                "X-CSRFToken": formData2.get("csrfmiddlewaretoken")
            },
            body: formData2
        })
    });

    const form3 = document.getElementById("reset-panel-form");
    form3.addEventListener("submit", async function(event) {
        event.preventDefault(); // prevent page reload

        const formData3 = new FormData(form);

        // Fetch POST request to your Django view
        const response = await fetch(RESET_PANEL_URL, {
            method: "POST",
            headers: {
                "X-CSRFToken": formData3.get("csrfmiddlewaretoken")
            },
            body: formData3
        })
    });


    const socket = new WebSocket(
        'ws://' + window.location.host + '/ws/pdf-preview/'
    );

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.event === "pdf_ready") {
            console.log("date.event is in fact pdf_ready")
            console.log(data.url)
            document.getElementById('pdfPreview').src = data.url;
        }
        else if (data.event == "reset_panel") {
            const experiencesData = data.minor_experiences_data;
            const container = document.getElementById('minor-experiences-container');
            container.innerHTML = "";

            experiencesData.forEach(exp => {
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'content-wrapper';

                const buttonWrapper = document.createElement('div');
                buttonWrapper.className = 'button-wrapper';

                const addButton = document.createElement("button");
                addButton.type = "button";
                if (exp.included) {
                    addButton.textContent = 'Remove from PDF';
                    addButton.onclick = () => removeFromPDF(exp.id, 'minor-experience');
                } else {
                    addButton.textContent = 'Add to PDF';
                    addButton.onclick = () => addToPDF(exp.id, 'minor-experience');
                }

                const editButton = document.createElement('button');
                editButton.type = 'button';
                editButton.textContent = 'Apply edits';
                editButton.onclick = () => editItem(exp.id, 'minor-experience');

                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => deleteItem(exp.id, 'minor-experience');

                const contentDiv = document.createElement('div');
                contentDiv.className = 'experience-content';
                contentDiv.id = `experience-${exp.id}`
                contentDiv.dataset.id = exp.id;
                contentDiv.dataset.name = exp.name;
                contentDiv.dataset.organisation = exp.organisation;
                contentDiv.dataset.date = exp.date;
                contentDiv.dataset.location = exp.location;

                contentDiv.innerHTML = `
                    <h3 class="content-label">Position name</h3>
                    <div class="editable-field" data-field="name" contenteditable="true">${exp.name}</div>
                    
                    <h3 class="content-label">Organisation</h3>
                    <div class="editable-field" data-field="organisation" contenteditable="true">${exp.organisation}</div>
                    
                    <h3 class="content-label">Date start/end</h3>
                    <div class="editable-field" data-field="date" contenteditable="true">${exp.date}</div>
                    
                    <h3 class="content-label">Location</h3>
                    <div class="editable-field" data-field="location" contenteditable="true">${exp.location}</div>
                    
                    <h3 class="content-label">Description</h3>
                `;

                const descriptionsDiv = document.createElement('div');
                descriptionsDiv.id = `descriptions-${exp.id}`;

                exp.descriptions.forEach((desc, index) => {
                    const description = document.createElement('div');
                    description.classList.add("description", "editable-field");
                    description.dataset.id = desc[0];
                    description.contentEditable = true;
                    description.innerText = desc[1]

                    descriptionsDiv.appendChild(description);
                });
                
                buttonWrapper.appendChild(addButton);
                buttonWrapper.appendChild(editButton);
                buttonWrapper.appendChild(deleteButton);

                contentDiv.appendChild(descriptionsDiv);
                
                contentWrapper.appendChild(buttonWrapper);
                contentWrapper.appendChild(contentDiv);
                
                // Append the new content to the container
                container.appendChild(contentWrapper);
            });
        }
    };
</script>
<script src="{% static 'static-resume/script.js' %}"></script> 
</html>