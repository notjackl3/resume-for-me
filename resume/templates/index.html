{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'static-resume/style.css' %}">
    <title>Document</title>
</head>
<body>
    <h1>Hello World</h1>
    
    <!-- <embed src="{{ MEDIA_URL }}media-resume/resume.pdf" type="application/pdf" width="100%" height="600px" title="PDF Document"></embed> -->

    <iframe id="pdfPreview" width="100%" height="600px" frameborder="0" title="PDF Document"></iframe>
    <!-- src="{{ MEDIA_URL }}media-resume/resume.pdf" -->

    <div class="main-container">
        <form id="add-experience-form">
            {% csrf_token %}
        
            <h1>Add Work Experience</h1>
            <label for="name">Experience Name:</label>
            <input type="text" id="name" name="name" maxlength="100" required><br><br>
            <label for="date">Date:</label>
            <input type="text" id="date" name="date" maxlength="100" required><br><br>
            <label for="location">Location:</label>
            <input type="text" id="location" name="location" maxlength="100" required><br><br>
            <label for="organisation">Organisation:</label>
            <input type="text" id="organisation" name="organisation" maxlength="100" required><br><br>
        
            <h3>Descriptions</h3>
            <label for="description1">Description 1:</label><br>
            <textarea id="description1" name="descriptions[]" rows="3" cols="50"></textarea><br><br>
            <label for="description2">Description 2:</label><br>
            <textarea id="description2" name="descriptions[]" rows="3" cols="50"></textarea><br><br>
            <label for="description3">Description 3:</label><br>
            <textarea id="description3" name="descriptions[]" rows="3" cols="50"></textarea><br><br>
        
            <button type="submit">Submit Experience</button>
        </form>   

        <div class="sub-container">
            <h1 id="section">Experiences</h1>
            <div id="minor-experiences-container" class="content-container">
                {% for exp in minor_experiences %}
                <div class="content-wrapper">
                    <div class="button-wrapper">
                        {% if exp.included %}
                        <button type="button" onclick="removeFromPDF('{{ exp.id }}', 'minor-experience')">Remove from PDF</button>
                        {% else %}
                        <button type="button" onclick="addToPDF('{{ exp.id }}', 'minor-experience')">Add to PDF</button>
                        {% endif %}
                        <button type="button" onclick="deleteItem('{{ exp.id }}', 'minor-experience')">Delete</button>
                    </div>
                    <div data-id="{{ exp.id }}" data-name="{{ exp.name }}" data-organisation="{{ exp.organisation }}" data-date="{{ exp.date }}" data-location="{{ exp.location }}" class="content">
                        <h3 class="content-label">Position name</h3>
                        <p id="name">{{ exp.name }}</p>
                        <h3 class="content-label">Organisation</h3>
                        <p id="organisation" class="content-data">{{ exp.organisation }}</p>
                        <h3 class="content-label">Date start/end</h3>
                        <p id="date" class="content-data">{{ exp.date }}</p>
                        <h3 class="content-label">Location</h3>
                        <p id="location" class="content-data">{{ exp.location }}</p>
                        <h3 class="content-label">Description</h3>
                        <div id="descriptions">
                            {% for desc in exp.descriptions %}
                            <p class="description" class="content-data">{{ desc.content }}</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <form id="prepare-pdf-form">
        <button type="submit">Prepare pdf</button>
    </form>
    <form id="reset-panel-form">
        <button type="submit">Reset panel</button>
    </form>


</body>
<script>
    const form = document.getElementById("add-experience-form");
    const PREPARE_PDF_URL = "{% url 'prepare_pdf' %}";
    const RESET_PANEL_URL = "{% url 'reset_panel' %}";
    const DELETE_URL = "{% url 'delete_experience' %}";
    const EDIT_URL = "{% url 'edit_experience' %}";

    window.onload = () => {
        fetch(PREPARE_PDF_URL);    
        fetch(RESET_PANEL_URL);
    };

    form.addEventListener("submit", async function(event) {
        event.preventDefault(); // prevent page reload

        const formData = new FormData(form);
        const response = await fetch(`{% url 'add_experience' %}?type=minor-experience`, {
            method: "POST",
            headers: {
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            },
            body: formData
        });

        if (response.ok) {
            const data = await response.json();
            console.log("Experience added successfully:", data);
            form.reset();
            fetch(RESET_PANEL_URL);
        } else {
            console.error("Error adding experience");
        }
    });

    const form2 = document.getElementById("prepare-pdf-form");
    form2.addEventListener("submit", async function(event) {
        event.preventDefault(); // prevent page reload

        const formData2 = new FormData(form);

        // Fetch POST request to your Django view
        const response = await fetch(PREPARE_PDF_URL, {
            method: "POST",
            headers: {
                "X-CSRFToken": formData2.get("csrfmiddlewaretoken")
            },
            body: formData2
        })
    });

    const form3 = document.getElementById("reset-panel-form");
    form3.addEventListener("submit", async function(event) {
        event.preventDefault(); // prevent page reload

        const formData3 = new FormData(form);

        // Fetch POST request to your Django view
        const response = await fetch(RESET_PANEL_URL, {
            method: "POST",
            headers: {
                "X-CSRFToken": formData3.get("csrfmiddlewaretoken")
            },
            body: formData3
        })
    });


    const socket = new WebSocket(
        'ws://' + window.location.host + '/ws/pdf-preview/'
    );

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.event === "pdf_ready") {
            console.log("date.event is in fact pdf_ready")
            console.log(data.url)
            document.getElementById('pdfPreview').src = data.url;
        }
        else if (data.event == "reset_panel") {
            const experiencesData = data.minor_experiences_data;
            const container = document.getElementById('minor-experiences-container');

            console.log("resetting panel")
            console.log(experiencesData)
            
            // Clear any existing content
            container.innerHTML = '';

            // Loop through the data and create new HTML elements
            experiencesData.forEach(exp => {
                // Create the main content wrapper
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'content-wrapper';

                // Create the button wrapper
                const buttonWrapper = document.createElement('div');
                buttonWrapper.className = 'button-wrapper';

                // Create "Add/Remove from PDF" button
                const addButton = document.createElement('button');
                addButton.type = 'button';
                if (exp.included) {
                    addButton.textContent = 'Remove from PDF';
                    addButton.onclick = () => removeFromPDF(exp.id, 'minor-experience');
                } else {
                    addButton.textContent = 'Add to PDF';
                    addButton.onclick = () => addToPDF(exp.id, 'minor-experience');
                }
                buttonWrapper.appendChild(addButton);

                // Create "Delete" button
                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => deleteItem(exp.id, 'minor-experience');
                buttonWrapper.appendChild(deleteButton);

                // Create the content div
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';
                contentDiv.dataset.id = exp.id;
                contentDiv.dataset.name = exp.name;
                contentDiv.dataset.organisation = exp.organisation;
                contentDiv.dataset.date = exp.date;
                contentDiv.dataset.location = exp.location;

                // Add the content to the div
                contentDiv.innerHTML = `
                    <h3 class="content-label">Position name</h3>
                    <p id="name">${exp.name}</p>
                    <h3 class="content-label">Organisation</h3>
                    <p id="organisation" class="content-data">${exp.organisation}</p>
                    <h3 class="content-label">Date start/end</h3>
                    <p id="date" class="content-data">${exp.date}</p>
                    <h3 class="content-label">Location</h3>
                    <p id="location" class="content-data">${exp.location}</p>
                    <h3 class="content-label">Description</h3>
                `;
                
                // Create the descriptions div and populate it
                const descriptionsDiv = document.createElement('div');
                descriptionsDiv.id = 'descriptions';
                exp.descriptions.forEach(desc => {
                    const descriptionParagraph = document.createElement('p');
                    descriptionParagraph.className = 'description content-data';
                    descriptionParagraph.textContent = desc; // The description is just a string now
                    descriptionsDiv.appendChild(descriptionParagraph);
                });
                contentDiv.appendChild(descriptionsDiv);

                // Append everything to the main wrapper
                contentWrapper.appendChild(buttonWrapper);
                contentWrapper.appendChild(contentDiv);
                
                // Append the new content to the container
                container.appendChild(contentWrapper);
            });
        }
    };
</script>
<script src="{% static 'static-resume/script.js' %}"></script> 
</html>